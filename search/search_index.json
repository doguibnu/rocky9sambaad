{"config":{"lang":["pt"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Rocky-Samba","text":""},{"location":"#samba-ad-dc-rocky-linux","title":"SAMBA AD-DC &amp; Rocky Linux","text":"<p>\u00daltima Atualiza\u00e7\u00e3o | 03/07/2024 | 20:48</p> <p></p> <p>Nesta documenta\u00e7\u00e3o iremos tratar como fazer a instala\u00e7\u00e3o e configura\u00e7\u00e3o do Samba em <code>modo compilado</code> para o sistema operacional Rocky Linux 9.x</p> <p>A vers\u00e3o do samba que ser\u00e1 utilizada para o processo ser\u00e1 a vers\u00e3o 4.19.5. A Primeira M\u00e1quina ser\u00e1 o <code>Controlador de Dom\u00ednio Principal</code>, ou seja, o DC1.</p> <p>Teremos tamb\u00e9m uma Segunda M\u00e1quina que servir\u00e1 como <code>Replicador</code> do DC1 para o <code>Membro de Dom\u00ednio Secund\u00e1rio</code> ou seja, o DC2.</p> <p>E finalmente, uma Terceira M\u00e1quina que servir\u00e1 como <code>Servidor de Arquivos do AD.</code> </p>"},{"location":"#por-que-rocky-linux","title":"Por que Rocky Linux ?","text":"<p>\"O Rocky Linux \u00e9 um sistema operacional empresarial de c\u00f3digo aberto projetado para ser 100% bug-a-bug compat\u00edvel com o Red Hat Enterprise Linux\u00ae. Est\u00e1 em intenso desenvolvimento pela comunidade.\"</p> <p>Assim como o <code>Debian</code>, o <code>Rocky Linux</code> \u00e9 robusto, est\u00e1vel e leve, focado em produ\u00e7\u00e3o, corre\u00e7\u00f5es e atualiza\u00e7\u00f5es. Conta com um longo tempo de suporte e atualiza\u00e7\u00f5es, o que por si s\u00f3 \u00e9 muito importante para administradores de sistema.</p> <p>Se desejar acessar o site oficial, acesse este endere\u00e7o.</p> <p>Para baixar o Rocky Linux 9.x acesse a P\u00e1gina de Download.</p>"},{"location":"fileserver/fileserver/","title":"Servidor de Arquivos","text":""},{"location":"fileserver/fileserver/#membro-e-servidor-de-arquivos-do-ad","title":"Membro e Servidor de Arquivos do AD","text":"<p>Vamos configurar a Terceira m\u00e1quina  que servir\u00e1 como servidor de arquivos do AD</p>"},{"location":"fileserver/fileserver/#iniciando-o-processo","title":"Iniciando o processo","text":""},{"location":"fileserver/fileserver/#update-e-upgrade-do-sistema","title":"Update e Upgrade do sistema","text":"<p>Fa\u00e7a um <code>update</code> e um <code>upgrade</code> do sistema. Utilize o comando:</p> <pre><code>dnf update -y &amp;&amp; dnf upgrade -y\n</code></pre>"},{"location":"fileserver/fileserver/#instale-o-samba-e-pacotes-necessarios","title":"Instale o Samba e pacotes necess\u00e1rios","text":"<p>Instale o <code>samba</code> e seus pacotes necess\u00e1rios para <code>servidor de arquivos</code> e tamb\u00e9m o editor de textos <code>nano</code>. Observe que iremos utilizar os pacotes dispon\u00edveis do Rocky Linux, sem precisar baixar e compilar o samba.  Utilize o comando abaixo:</p> <pre><code>dnf install -y nano samba samba-winbind samba-winbind-clients bind-utils\n</code></pre> <p><code>Habilite</code> os servi\u00e7os <code>smb nmb e winbind</code> para iniciar junto ao boot do sistema:</p> <pre><code>systemctl enable smb nmb winbind\n</code></pre>"},{"location":"fileserver/fileserver/#configure-e-edite-o-arquivo-etchosts","title":"Configure e edite o arquivo <code>/etc/hosts</code>:","text":"<p>Utilize o editor de texto <code>nano</code> para editar o arquivo <code>/etc/hosts</code></p> <pre><code>nano /etc/hosts\n</code></pre> <pre><code>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n10.1.1.13   SRVFILE.seu.dominio SRVFILE\n::1 localhost localhost.localdomain localhost6 localhost6.localdomain6\n</code></pre> <p>Onde:</p> <p><code>10.1.1.13</code> = IP do seu Servidor de Arquivos</p> <p><code>SRVFILE.seu.dominio</code> = nome completo do host+dom\u00ednio</p> <p><code>SRVFILE</code> = nome curto de seu host</p> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"fileserver/fileserver/#edite-o-arquivo-etchostname","title":"Edite o arquivo <code>/etc/hostname</code>","text":"<p>Com o editor de textos <code>nano</code> edite o arquivo <code>/etc/hostname</code> com o comando:</p> <pre><code>nano /etc/hostname\n</code></pre> <pre><code>srvfile.seu.dominio\n</code></pre> <p>Salve o Arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"fileserver/fileserver/#editar-o-arquivo-etcnsswitchconf","title":"Editar o arquivo <code>/etc/nsswitch.conf</code>","text":"<p>Com o editor de textos <code>nano</code> edite o arquivo /etc/nsswitch.conf com o comando:</p> <pre><code>nano /etc/nsswitch.conf\n</code></pre> <p>Localize as Linhas e Mude a configura\u00e7\u00e3o:</p> <pre><code>De:\npasswd: sss files systemd\n\nPara:\npasswd: files winbind\n\n\nDe:\ngroup: sss files systemd\n\nPara:\ngroup: files winbind\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"fileserver/fileserver/#configure-a-rede","title":"Configure a Rede","text":"<p>Configure a rede e insira os dados do <code>DNS</code> sendo o IP do  seu <code>DC1</code> ou seja, do seu Controlador de dom\u00ednio <code>DC1</code>. Execute o comando <code>nmtui</code>:</p> <pre><code>nmtui\n</code></pre> <p>Selecione <code>Editar uma Conex\u00e3o</code></p> <p>Digite <code>Enter</code></p> <p>Com a tela <code>Tab</code> selecione <code>Editar</code></p> <p>Com as <code>teclas de dire\u00e7\u00e3o (setas)</code> mova-se at\u00e9 <code>Servidores DNS</code> e troque o <code>IP para o IP de seu AD DC</code> (controlador de dom\u00ednio-<code>DC1</code>)</p> <p>Ainda com as setas de dire\u00e7\u00e3o, selecione <code>Dom\u00ednios de pesquisa</code> e insira: <code>seu.dom\u00ednio</code></p> <p>Ent\u00e3o, selecione <code>OK</code> <code>com as setas de dire\u00e7\u00e3o</code> e digite <code>enter</code>.</p> <p>Com a <code>tecla Tab</code>, selecione a op\u00e7\u00e3o: <code>voltar</code> e digite a tecla <code>enter</code>.  Com a tecla <code>Tab</code>, selecione a <code>op\u00e7\u00e3o OK</code> e digite <code>enter</code>.</p>"},{"location":"fileserver/fileserver/#reinicie-o-sistema","title":"Reinicie o sistema","text":"<p>Execute o comando <code>reboot</code> para reiniciar o sistema</p> <pre><code>reboot\n</code></pre>"},{"location":"fileserver/fileserver/#arquivo-usermap","title":"Arquivo <code>user.map</code>","text":"<p>Crie e edite o arquivo user.map no diret\u00f3rio <code>/etc/samba</code> com o conte\u00fado:</p> <pre><code>nano /etc/samba/user.map\n</code></pre> <pre><code>!root = DOMINIO\\Administrator\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"fileserver/fileserver/#backup-do-arquivo-original-smbconf","title":"Backup do arquivo original <code>smb.conf</code>","text":"<p>Crie um backup do arquivo <code>/etc/samba/smb.conf</code> com o comando:</p> <pre><code>mv /etc/samba/smb.conf /etc/samba/smb.conf.bkp\n</code></pre>"},{"location":"fileserver/fileserver/#verificar-dispositivo-de-rede","title":"Verificar dispositivo de rede","text":"<p>Veifique seu dispositivo de rede, pois  o mesmo ser\u00e1 inserido no arquivo que ser\u00e1 criado. Execute o comando:</p> <pre><code>ip a\n</code></pre> <pre><code>2: enp1s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    link/ether 52:54:00:fc:1d:33 brd ff:ff:ff:ff:ff:ff\n    inet 10.1.1.41/24 brd 10.1.1.255 scope global noprefixroute enp1s0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::5054:ff:fefc:1d33/64 scope link noprefixroute \n       valid_lft forever preferred_lft forever\n</code></pre> <p>Seu dispositivo neste caso \u00e9 o: enp1s0</p>"},{"location":"fileserver/fileserver/#crie-e-edite-o-arquivo-smbconf","title":"Crie e edite o arquivo <code>smb.conf</code>","text":"<p>Vamos criar e editar o arquivo <code>/etc/samba/smb.conf.</code> <code>Copie</code> e <code>cole</code>o conte\u00fado para seu arquivo e n\u00e3o esque\u00e7a de <code>alterar</code> conforme suas informa\u00e7\u00f5es. Execute o comando:</p> <pre><code>nano /etc/samba/smb.conf\n</code></pre> <pre><code>[global]\n    bind interfaces only = Yes\n    interfaces = lo enp1s0 # sua interface\n    dedicated keytab file = /etc/krb5.keytab\n    kerberos method = secrets and keytab\n    log file = /var/log/samba/%m.log\n    min domain uid = 0\n    realm = SEU.DOMINIODE       \n    username map = /etc/samba/user.map\n    security = ADS\n    template homedir = /home/%U\n    template shell = /bin/bash\n    winbind refresh tickets = Yes\n    winbind use default domain = Yes\n    workgroup = DOMINIO\n    idmap config dominio : range = 10000-999999\n    idmap config dominio : backend = rid\n    idmap config * : range = 3000-7999\n    idmap config * : backend = tdb\n    map acl inherit = Yes\n    vfs objects = acl_xattr\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"fileserver/fileserver/#backup-do-arquivo-krb5conf","title":"Backup do arquivo <code>krb5.conf</code>","text":"<p>Fa\u00e7a uma c\u00f3pia do arquivo <code>/etc/krb5.conf</code> com o comando:</p> <pre><code>mv /etc/krb5.conf /etc/krb5.conf.bkp\n</code></pre>"},{"location":"fileserver/fileserver/#crie-um-novo-arquivo-krb5conf","title":"Crie um novo arquivo <code>krb5.conf</code>","text":"<p>Crie e edite um novo arquivo <code>krb5.conf</code> e insira as linhas <code>alterando</code> para seu cen\u00e1rio. Utilize o comando:</p> <pre><code>nano /etc/krb5.conf\n</code></pre> <pre><code>[libdefaults]\n    dns_lookup_realm = false\n    dns_lookup_kdc = true\n    default_realm = SEU.DOMINIO\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code>e para sair: <code>control+x</code></p>"},{"location":"fileserver/fileserver/#comando-testparm","title":"Comando <code>testparm</code>","text":"<p>Verifique se existe algum erro de sintaxe com o comando:</p> <pre><code>testparm\n</code></pre> <p>Se n\u00e3o houver erros, execute o comando para <code>recarregar</code> o samba novamente:</p> <pre><code>smbcontrol all reload-config\n</code></pre>"},{"location":"fileserver/fileserver/#desabilite-o-selinux","title":"Desabilite o <code>SELinux</code>","text":"<p>Com o editor de textos <code>nano</code> edite e altere o arquivo </p> <pre><code>nano /etc/selinux/config\n</code></pre> <pre><code>Na linha `SELINUX=enforcing`\ntroque para:\nSELINUX=disabled\n\nSalve o arquivo\n</code></pre> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"fileserver/fileserver/#ajuste-o-firewall","title":"Ajuste o Firewall","text":"<p>Ajuste o Firewall, adicione o <code>servi\u00e7o</code> do <code>samba</code> e recarregue o Firewall com os comandos abaixo:</p> <pre><code>firewall-cmd --add-service=samba --permanent\nfirewall-cmd --reload\n</code></pre>"},{"location":"fileserver/fileserver/#reiniciar-o-servidor","title":"<code>Reiniciar</code> o servidor","text":"<p>Reinicie o servidor de arquivos com o comando:</p> <pre><code>reboot\n</code></pre>"},{"location":"fileserver/fileserver/#junte-se-ao-ad-dc1-join-ad","title":"Junte-se ao AD-DC1 (join AD)","text":"<p>Utilize o comando abaixo para juntar-se ao seu Controlador de Dom\u00ednio Principal DC1:</p> <pre><code>net ads join -U administrator  \nEnter administrator's password: senha do provisionamento\n</code></pre> <pre><code>Using short domain name -- DOMINIO  \nJoined 'SRVFILE' to dns domain 'seu.dominio'\n</code></pre>"},{"location":"fileserver/fileserver/#verifique-a-conexao-netlogon","title":"<code>Verifique</code> a conex\u00e3o NETLOGON","text":"<p>Verifique a conex\u00e3o <code>Netlogon</code> com o AD. Utilize o comando:</p> <pre><code>wbinfo --ping-dc\n</code></pre> <p>A sa\u00edda do comando deve parecer como esta abaixo:</p> <pre><code>checking the NETLOGON for domain[DOMINIO] dc connection to \"DC1.seu.dominio\" succeeded\n</code></pre>"},{"location":"fileserver/fileserver/#nslookup","title":"Nslookup","text":"<p>Verifique se o seu <code>DC1</code> (seu controlador de dominio principal) retorna com a resposta, executando o comando: <code>nslookup SEU.DOMINIO</code>. <code>Altere</code> os dados conforme seu cen\u00e1rio:</p> <pre><code>nslookup DC1.SEU.DOMINIO\n</code></pre> <p>Um resultado parecido como abaixo deve aparecer na tela:</p> <pre><code>nslookup DC1.seu.dominio\nServer: 10.1.1.31\nAddress: 10.1.1.31#53\n\nName: DC1.seu.dominio\nAddress: 10.1.1.31\n</code></pre> <p>Tamb\u00e9m atrav\u00e9s do <code>IP do seu DC1</code> com o comando:</p> <pre><code>nslookup IP-serverad\n</code></pre> <p>Antes de prosseguir, conecte-se em seu DC1 e <code>crie</code> um <code>grupo</code> e um <code>usu\u00e1rio</code>. No DC1 execute o comando para criar o <code>grupo</code> por exemplo:</p> <pre><code>samba-tool group add 'Linux Domain'\n</code></pre> <p>Logo ap\u00f3s <code>adicione</code> um <code>usu\u00e1rio</code> com o comando:</p> <pre><code>samba-tool user add 'Linux Test'\n</code></pre>"},{"location":"fileserver/fileserver/#volte-para-o-servidor-de-arquivos","title":"Volte para o Servidor de Arquivos","text":""},{"location":"fileserver/fileserver/#gid-grupo-a-partir-do-servidor-de-arquivos","title":"GID grupo a partir do <code>Servidor de Arquivos</code>","text":"<p>Verifique se retorna o <code>GID (n\u00famero do Grupo)</code> criado. Utilize o comando abaixo. A sa\u00edda deve ser algo parecido como:</p> <pre><code>getent group \"DOMINIO\\\\Linux Domain\"\nlinux domain:x:11115:\n</code></pre>"},{"location":"fileserver/fileserver/#garantir-privilegios","title":"Garantir Privil\u00e9gios","text":"<p>Garanta o privil\u00e9gio de acesso para o usu\u00e1rio Administrator estar apto a <code>ler/escrever/apagar</code> dentro do disco. OBS: Altere o comando conforme seu cen\u00e1rio. Utilize o comando:</p> <pre><code>net rpc rights grant \"DOMINIO\\Domain Admins\" SeDiskOperatorPrivilege -U \"DOMINIO\\Administrator\"\nEnter DOMINIO\\Administrator password: senha CRIADA no provisionamento do DC1\n# Caso tenha criado corretamente o sistema ir\u00e1 dar sucesso do comando\n\nSuccessfully granted rights.\n</code></pre> <p>Recebendo a resposta como sucesso, est\u00e1 apto a iniciar a configura\u00e7\u00e3o de <code>montagem de disco</code>, o <code>diret\u00f3rio</code> escolhido para abrigar seus arquivos e ajustar as <code>permiss\u00f5es</code> de acesso, para que seja poss\u00edvel fazer a <code>Administra\u00e7\u00e3o</code> atrav\u00e9s da <code>Ferramenta RSAT do seu Windows</code>.</p> <p>Por Exemplo:</p> <p>Caso tenha configurado um disco e <code>disponibilizou/montou</code> o diret\u00f3rio: /srv/ad, \u00e9 necess\u00e1rio indicar esse caminho em seu arquivo smb.conf , que est\u00e1 no diret\u00f3rio: <code>/etc/samba/smb.conf</code>.  Dentro do arquivo, localize a sess\u00e3o global, indicando o <code>nome de seu compartilhamento</code> do servidor de arquivos, <code>caminho</code> e ent\u00e3o ajuste as <code>permiss\u00f5es de acesso</code> seguindo o exemplo abaixo:</p> <p><code>OBS: Altere os dados conforme seu cen\u00e1rio</code></p> <pre><code>nano /etc/samba/smb.conf\n</code></pre> <pre><code>[arqTeste]\n   path = /srv/ad/\n   read only = no\n   browseable = yes\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"fileserver/fileserver/#ajustando-permissoes","title":"Ajustando Permiss\u00f5es","text":"<p>Ajuste as <code>permiss\u00f5es</code> para o Grupo no diret\u00f3rio criado. Utilize os comandos:</p> <pre><code>chown root:\"Domain Admins\" /srv/ad\nchmod 0770 -R /srv/ad\n</code></pre>"},{"location":"fileserver/fileserver/#recarregar-o-samba","title":"<code>Recarregar</code> o samba","text":"<p>Recarregue novamente o <code>smbcontrol</code>com o comando:</p> <pre><code>smbcontrol all reload-config\n</code></pre>"},{"location":"fileserver/fileserver/#rsat-windows","title":"RSAT Windows","text":"<p>Atrav\u00e9s do Windows, logue-se com a conta <code>Administrator</code> e atrav\u00e9s do RSAT inicie suas configura\u00e7\u00f5es desejadas.</p>"},{"location":"samba-dc2/sambadc2/","title":"Samba AD-DC2 Replicador","text":""},{"location":"samba-dc2/sambadc2/#samba-ad-dc-controlador-dominio-dc2-replicador-dc1","title":"Samba AD-DC Controlador Dom\u00ednio (DC2) Replicador DC1","text":"<p>Vamos configurar a Segunda m\u00e1quina para agir como um <code>Replicador</code> do <code>DC1</code> (backup).</p> <p>OBS: Seu DC1 deve neste momento estar operacional e funcionando corretamente. Antes de continuar, fa\u00e7a esta verifica\u00e7\u00e3o.</p>"},{"location":"samba-dc2/sambadc2/#iniciando-o-processo","title":"Iniciando o processo:","text":""},{"location":"samba-dc2/sambadc2/#execute-update-e-upgrade-do-sistema","title":"Execute <code>Update</code> e <code>Upgrade</code> do sistema:","text":"<p>Execute um update e um upgrade do sistema com o comando abaixo:</p> <pre><code>dnf update -y &amp;&amp; dnf upgrade -y\n</code></pre>"},{"location":"samba-dc2/sambadc2/#instale-o-nano-e-o-wget","title":"Instale o <code>nano</code> e o <code>wget</code>","text":"<p>Instale o editor de textos <code>nano</code> e a ferramenta <code>wget</code> com o comando:</p> <pre><code>dnf install -y nano wget\n</code></pre>"},{"location":"samba-dc2/sambadc2/#verifique-a-rede","title":"Verifique a rede","text":"<p>Verifique  sua configura\u00e7\u00e3o de rede. O DNS deve ser <code>PREFERENCIALMENTE</code> o IP do <code>Controlador de dom\u00ednio (DC1)</code>,  bem como nome de dom\u00ednio e um <code>IP fixo</code>. Uma das op\u00e7\u00f5es para configurar a rede, \u00e9 executar o comando <code>nmtui</code> que abre uma <code>GUI</code> no <code>terminal</code>:</p> <pre><code> nmtui\n</code></pre> <p>Selecione <code>Editar uma conex\u00e3o</code></p> <p>Ent\u00e3o a op\u00e7\u00e3o <code>Editar</code></p> <p>Verifique ou altere seu <code>endere\u00e7o ip</code>, <code>m\u00e1scara de sub-rede</code> e seu <code>Gateway</code></p> <p>Na op\u00e7\u00e3o <code>Servidor DNS</code> insira PREFERENCIALMENTE o ip de seu <code>Controlador de Dom\u00ednio Principal (DC1)</code></p> <p>N\u00e3o esque\u00e7a de inserir em <code>Dom\u00ednios de pesquisa:</code> seu.dom\u00ednio.</p> <p>V\u00e1 at\u00e9 o fim e selecione <code>OK</code> para salvar.</p> <p>Selecione <code>Voltar</code> e ent\u00e3o no menu, selecionar a op\u00e7\u00e3o:</p> <p><code>Definir nome de m\u00e1quina do sistema:</code> dc2.seu.dominio.</p> <p>Agora selecione a op\u00e7\u00e3o: <code>OK</code> para salvar. Novamente selecione <code>OK</code>. Deve retornar para o terminal.</p>"},{"location":"samba-dc2/sambadc2/#edite-o-arquivo-etchosts","title":"Edite o arquivo <code>/etc/hosts</code>","text":"<p>Com o editor de textos <code>nano</code> edite o arquivo <code>/etc/hosts</code> com o comando:</p> <pre><code>nano /etc/hosts\n</code></pre> <p>Insira os dados referentes ao seu Controlador de Dom\u00ednio DC2:</p> <pre><code>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n# insira os dados de seu MEMBRO DE DOM\u00cdNIO\n10.1.1.38   dc2                             dc2.seu.dominio\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p> <p>Onde:</p> <p>10.1.1.38 = IP de seu DC2</p> <p>dc2 = nome curto do host do DC2</p> <p>dc2.seu.dom\u00ednio = nome curto de seu host + seu dom\u00ednio</p>"},{"location":"samba-dc2/sambadc2/#algum-samba-rodando","title":"Algum <code>Samba</code> rodando","text":"<p>Verifique se existe algum processo do samba rodando com o comando:</p> <pre><code> ps ax | egrep \"samba|smbd|nmbd|winbindd\"\n</code></pre> <p>Remova qualquer configura\u00e7\u00e3o <code>smb.conf</code> que houver, checando com o comando:</p> <pre><code>smbd -b | grep \"CONFIGFILE\"\n# o resultado deve ser parecido com a linha abaixo:\n-bash: smbd: command not found\n</code></pre>"},{"location":"samba-dc2/sambadc2/#remova-o-arquivo-etckrb5conf","title":"Remova o arquivo <code>/etc/krb5.conf</code>","text":"<p>Remova o arquivo /etc/krb5.conf se houver, com o comando:</p> <pre><code>rm /etc/krb5.conf -y\n</code></pre>"},{"location":"samba-dc2/sambadc2/#instale-os-repositorios-de-plugins-crb-e-epel","title":"Instale os reposit\u00f3rios de Plugins <code>CRB</code> e <code>Epel</code>","text":"<p>Instale os plugins e habilite o reposit\u00f3rio <code>CRB</code>. Instale tamb\u00e9m o reposit\u00f3rio <code>epel release</code> e execute um <code>update</code> com os comandos abaixo:</p> <pre><code>dnf config-manager --enable crb &amp;&amp; dnf install epel-release -y &amp;&amp; dnf update -y\n</code></pre> <p><code>Cheque</code> os reposit\u00f3rios adicionados com o comando:</p> <pre><code>dnf repolist\n</code></pre> <p>O resultado deve ser algo como:</p> <p></p>"},{"location":"samba-dc2/sambadc2/#setar-servidor-ntp-horario","title":"Setar servidor <code>NTP</code> (hor\u00e1rio):","text":"<p>Liste as op\u00e7\u00f5es de hora local com o comando:</p> <pre><code>timedatectl list-timezones\n</code></pre> <p>Para <code>setar o timezone</code> desejado, use o comando:\u00a0</p> <pre><code>timedatectl set-timezone America/Sao_Paulo \n</code></pre> <p>Verifique o <code>timezone</code> setado com o comando:</p> <pre><code>timedatectl\n</code></pre> <p>O resultado deve parecer como abaixo:</p> <pre><code>Local time: qua 2023-04-12 09:04:22 -03\n           Universal time: qua 2023-04-12 12:04:22 UTC\n                 RTC time: qua 2023-04-12 12:00:16\n                Time zone: America/Sao_Paulo (-03, -0300)\nSystem clock synchronized: yes\n              NTP service: active\n          RTC in local TZ: no \n</code></pre>"},{"location":"samba-dc2/sambadc2/#instale-dependencias-necessarias","title":"Instale depend\u00eancias necess\u00e1rias","text":"<p>Instale as depend\u00eancias necess\u00e1rias para compilar e instalar o samba. Crie um arquivo do tipo <code>script execut\u00e1vel</code> e insira os comandos no arquivo. No <code>terminal</code>, execute o editor de textos <code>nano</code> com o nome desejado do arquivo por exemplo:</p> <pre><code>nano depende.sh\n</code></pre> <p><code>Copie</code> e <code>Cole</code> as linhas abaixo para o seu arquivo:</p> <pre><code>set -xueo pipefail\n\ndnf install -y yum-utils\ndnf update -y\n\nyum install -y \\\ngcc.x86_64 \\\nkrb5-workstation.x86_64 \\\ntar \\\nbind \\\nbind-utils \\\npython3-devel \\\nwget \\\nnano \\\nperl.x86_64 perl-Parse-Yapp.noarch \\\nlibacl.x86_64 \\\nnfs4-acl-tools.x86_64 \\\ngnutls-devel.x86_64 \\\nzlib.x86_64 \\\nkrb5-devel.x86_64 \\\nkrb5-server \\\nlibblkid.x86_64 \\\ndbus-devel.x86_64 \\\njansson-devel.x86_64 \\\nreadline.x86_64 \\\nbsdtar.x86_64 \\\ndocbook-dtds.noarch \\\npam-devel \\\ncups \\\npython3-markdown \\\npatchutils.x86_64 \\\ngpgme-devel \\\nflex \\\npython3-iso8601.noarch \\\npython3-cryptography.x86_64 \\\npython3.11-devel.x86_64 \\\nlmdb.x86_64 \\\nlibarchive-devel \\\nlibacl-devel \\\nopenldap-devel \\\npython3-dns \\\nperl-Convert-ASN1.noarch \\\nrpcgen.x86_64 \\\nperl-App-cpanminus \\\npopt-devel.x86_64 \\\nzlib-devel.x86_64 \\\nlmdb-devel.x86_64 \\\nbison-devel.x86_64 \\\nlibtasn1-tools \\\nbison \\\nperl-JSON \\\nbzip2-devel \\\nopenssl-devel \\\n\nyum autoremove -y\n\nyum clean all\n</code></pre> <p>Salve o arquivo:</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p> <p>Transforme o arquivo criado em um arquivo <code>execut\u00e1vel</code> com o comando:</p> <pre><code>chmod +x depende.sh\n</code></pre> <p>Execute o arquivo para que o mesmo instale as depend\u00eancias necess\u00e1rias. Utilize o comando:</p> <pre><code>./depende.sh \n</code></pre>"},{"location":"samba-dc2/sambadc2/#download-do-samba-4195","title":"Download do Samba (4.19.5)","text":"<p>Fa\u00e7a o download do samba ou da vers\u00e3o desejada, utilizando o comando:</p> <pre><code>wget https://download.samba.org/pub/samba/stable/samba-4.19.5.tar.gz\n</code></pre> <p><code>Descompacte</code> o arquivo utilizando o comando:</p> <pre><code>tar -zxvf samba-nome-arquivo\n</code></pre> <p><code>Mude</code> para o diret\u00f3rio onde o arquivo foi descompactado com o comando:</p> <pre><code>cd samba-nome-arquivo/\n</code></pre>"},{"location":"samba-dc2/sambadc2/#compilar-o-samba","title":"Compilar o Samba","text":"<p><code>Compile</code> o samba e fa\u00e7a com que o arquivo de configua\u00e7\u00e3o (smb.conf) seja gravado no diret\u00f3rio /etc/samba/smb.conf com o comando:</p> <pre><code>./configure --sysconfdir=/etc/samba/\n</code></pre> <p>Aguarde o procedimento terminar.</p>"},{"location":"samba-dc2/sambadc2/#comandos-make-e-make-install","title":"Comandos <code>make</code> e <code>make install</code>","text":"<p>Execute os comandos <code>make</code> e <code>make install</code>:</p> <pre><code>make &amp;&amp; make install\n</code></pre> <p>Este processo pode ser demorado, aguarde at\u00e9 finalizar!</p> <p>Mude para o diret\u00f3rio <code>/root</code> e edite o arquivo <code>.bash_profile</code> para que o comando samba-tool possa ser executado de qualquer diret\u00f3rio. Execute os comandos:</p> <pre><code>cd /root\nnano .bash_profile\n</code></pre> <p>E insira a linha:</p> <pre><code># User specific environment and startup programs\nPATH=$PATH:$HOME/bin\n\n#ESTA LINHA:\nPATH=/usr/local/samba/bin/:/usr/local/samba/sbin/:$PATH\n\nexport PATH\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"samba-dc2/sambadc2/#servico-systemd-samba","title":"Servi\u00e7o <code>Systemd</code> Samba","text":"<p>Crie um arquivo de <code>servi\u00e7o systemd para o Samba</code>.  Mas antes execute os comandos:</p> <pre><code> systemctl mask smbd nmbd winbind\n systemctl disable smbd nmbd winbind\n</code></pre> <p>Crie o arquivo de servi\u00e7o do <code>samba-ad-dc</code> com o editor de texto <code>nano</code>. Execute o comando:</p> <pre><code>nano /etc/systemd/system/samba-ad-dc.service\n</code></pre> <p><code>Copie</code> e  <code>cole</code>  o conte\u00fado para seu arquivo:</p> <pre><code>[Unit]\nDescription=Samba Active Directory Domain Controller\nAfter=network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=forking\nExecStart=/usr/local/samba/sbin/samba -D\nPIDFile=/usr/local/samba/var/run/samba.pid\nExecReload=/bin/kill -HUP $MAINPID\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p>"},{"location":"samba-dc2/sambadc2/#recarregue-o-systemd","title":"Recarregue o <code>systemd</code>","text":"<p>Recarregue o <code>systemd</code> com o comando:</p> <pre><code>systemctl daemon-reload\n</code></pre> <p><code>Habilite</code> o <code>samba-ad-dc</code> para iniciar no boot do sistema:</p> <pre><code>systemctl enable samba-ad-dc\n</code></pre>"},{"location":"samba-dc2/sambadc2/#configure-o-firewall","title":"Configure o Firewall","text":"<p>Adicione os seguintes <code>servi\u00e7os</code> no firewall, com o comando abaixo:</p> <pre><code>firewall-cmd --add-service={dns,ldap,ldaps,kerberos}\n</code></pre> <p>Abra as portas <code>TCP</code> utilizadas pelo samba:</p> <pre><code>firewall-cmd --permanent --zone=public --add-port={53/tcp,135/tcp,139/tcp,389/tcp,445/tcp,465/tcp,636/tcp,3268/tcp,3269/tcp,49152-65535/tcp};\n</code></pre> <p>Abra as portas <code>UDP</code> utilizadas pelo samba:</p> <pre><code>firewall-cmd --permanent --zone=public --add-port={88/udp,123/udp,137/udp,138/udp,389/udp,464/udp};\n</code></pre> <p>Recarregue o <code>Firewall</code> com o comando:</p> <pre><code>firewall-cmd --reload\n</code></pre>"},{"location":"samba-dc2/sambadc2/#desabilite-o-selinux","title":"Desabilite o <code>SELinux</code>","text":"<p>Edite o arquivo <code>/etc/selinux/config</code> com o comando:</p> <pre><code>nano /etc/selinux/config\n</code></pre> <p>Encontre a linha e <code>altere</code> para a op\u00e7\u00e3o <code>disabled</code> como mostra abaixo:</p> <pre><code>#  disabled - No SELinux policy is loaded.\nSELINUX=disabled\n</code></pre> <p>Salve o arquivo:</p> <p>Para salvar: <code>control+o</code> e para sair <code>control+x</code></p>"},{"location":"samba-dc2/sambadc2/#reboot-o-sistema","title":"<code>Reboot</code> o sistema","text":"<p>Execute um reboot com o comando:</p> <pre><code>reboot\n</code></pre>"},{"location":"samba-dc2/sambadc2/#execute-o-comando-samba","title":"Execute o comando <code>samba</code>","text":"<p>Quando o sistema reiniciar execute o comando <code>samba</code></p> <pre><code>samba\n</code></pre>"},{"location":"samba-dc2/sambadc2/#junte-se-join-ad-ao-controlador-de-dominio-ad-dc","title":"Junte-se (join AD) ao <code>Controlador de Dom\u00ednio</code> (AD-DC)","text":"<p>Execute o comando  abaixo para juntar-se ao Active Directory (DC1) a partir de seu <code>Controlador de Dom\u00ednio (DC2)</code>. Substitua: seu.dom\u00ednio para seu cen\u00e1rio:</p> <pre><code>samba-tool domain join seu.dominio DC -Uadministrator --realm=seu.dominio\n</code></pre> <p>Ao final do processo, na \u00faltima linha deve mostrar: <code>Joined domain seu.dominio</code> como mostra na figura abaixo:</p> <p> </p> <p>Com o comando acima seu <code>Controlador de Dom\u00ednio DC2</code> deve juntar-se ao DC1 (Seu Controlador de Dom\u00ednio PRINCIPAL).</p>"},{"location":"sambadc1/samba-ad-dc1/","title":"Instalar Samba AD-DC (DC1)  Controlador de Dom\u00ednio Principal","text":""},{"location":"sambadc1/samba-ad-dc1/#inciando-o-processo","title":"Inciando o processo","text":"<p>No \u00ednicio da instala\u00e7\u00e3o do sistema, podemos inserir alguns dados como: <code>IP est\u00e1tico</code>, <code>DNS</code> e <code>Dom\u00ednio</code> como mostra a figura abaixo:</p> <p></p> <p>Continuando, temos a segunda tela para verifca\u00e7\u00e3o dos dados inseridos:</p> <p></p> <p>No resumo da instala\u00e7\u00e3o crie um <code>usu\u00e1rio e senha do sistema</code>. Crie tamb\u00e9m uma senha para o usu\u00e1rio <code>root</code> e Inicie a Instala\u00e7\u00e3o</p> <p></p> <p>ATEN\u00c7\u00c3O: TODOS os comandos utilizados ser\u00e3o como usu\u00e1rio <code>root.</code> </p> <p>Com o sistema instalado, teremos uma tela parecida como esta abaixo:</p> <p></p> <p>Ap\u00f3s ter logado no sistema, vamos <code>atualizar</code> e <code>remover</code> pacotes que n\u00e3o ser\u00e3o utilizados. Execute o comando: </p> <pre><code>dnf update -y &amp;&amp; dnf autoremove -y\n</code></pre> <p>Instale o utilit\u00e1rio <code>wget</code> e o editor de textos <code>nano</code> com o comando:</p> <pre><code>dnf install -y wget nano\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#verifique-a-rede","title":"Verifique a rede","text":"<p>Verifique sua configura\u00e7\u00e3o de rede . Seu controlador de dom\u00ednio deve possuir  um endere\u00e7o de <code>IP fixo</code>, ou seja, est\u00e1tico, m\u00e1scara de <code>sub-rede</code>, deve possuir um <code>IP de DNS</code>, um <code>Gateway</code> e o nome de <code>seu.dominio</code>. Uma das formas para configurar a rede pode ser atrav\u00e9s do terminal,  executando o comando que abre uma <code>GUI</code>:</p> <pre><code>nmtui\n</code></pre> <p>Selecione <code>Editar uma conex\u00e3o.</code></p> <p>Selecione a op\u00e7\u00e3o <code>Editar.</code></p> <p>Configure seu <code>endere\u00e7o ip</code> , m\u00e1scara de <code>Sub-rede</code> e seu <code>Gateway</code>.</p> <p>Na op\u00e7\u00e3o <code>Servidor DNS</code>: inserir o IP de DNS desejado .</p> <p>N\u00e3o esque\u00e7a de inserir em <code>Dom\u00ednios de pesquisa: seu.dom\u00ednio</code>.</p> <p>Com as teclas de dire\u00e7\u00e3o v\u00e1 at\u00e9 o fim e selecione <code>OK</code> para salvar.</p> <p>Selecione <code>Voltar</code> e ent\u00e3o no menu: <code>selecionar</code>  escolher a op\u00e7\u00e3o: <code>Definir nome de m\u00e1quina do sistema</code>:<code>dc1.seu.dominio</code>.</p> <p>Agora selecione a op\u00e7\u00e3o: <code>OK</code>\u00a0 para salvar. Novamente selecione <code>OK</code>. Deve retornar para o <code>terminal</code> do sistema.</p>"},{"location":"sambadc1/samba-ad-dc1/#editar-o-arquivo-etchost","title":"Editar o arquivo <code>/etc/host</code>:","text":"<p>No <code>terminal</code> execute o comando:</p> <pre><code>nano /etc/hosts\n</code></pre> <p>Insira os dados referentes ao seu servidor:</p> <pre><code>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n# inserir os dados de seu server DC\n10.1.1.120  dc1                             dc1.seu.dominio\n</code></pre> <p>Onde:</p> <p><code>10.1.1.120</code> =  \u00c9 o endere\u00e7o IP de seu pr\u00f3prio <code>AD-DC</code> (controlador de dom\u00ednio)</p> <p><code>dc1</code>  = \u00c9 nome simplificado do seu host controlador de dom\u00ednio</p> <p><code>dc1.seu.dom\u00ednio</code> = <code>nome do host</code> + <code>seu.dom\u00ednio</code></p>"},{"location":"sambadc1/samba-ad-dc1/#algum-samba-esta-rodando","title":"Algum Samba est\u00e1 rodando?","text":"<p>Verifique se existe algum processo do samba rodando. Utilize o comando:</p> <pre><code>ps ax | egrep \"samba|smbd|nmbd|winbindd\"\n</code></pre> <p>Remova qualquer configura\u00e7\u00e3o de arquivo: <code>smb.conf</code> que houver, checando com o comando:</p> <pre><code>smbd -b | grep \"CONFIGFILE\"\n# O resultado pode ser parecido com a linha abaixo:\n-bash: smbd: command not found\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#remova-o-arquivo-krb5conf","title":"Remova o arquivo <code>krb5.conf</code>","text":"<p>Remova o arquivo /etc/krb5.conf com o comando:</p> <pre><code>rm /etc/krb5.conf\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#instale-os-repositorios-de-plugins-crb-e-epel","title":"Instale os reposit\u00f3rios de Plugins <code>CRB</code> e <code>Epel</code>","text":"<p>Instale os plugins habilitando o reposit\u00f3rio <code>CRB</code>. Instale tamb\u00e9m o reposit\u00f3rio <code>epel release</code> e execute um <code>update</code> com os comandos abaixo:</p> <pre><code>dnf config-manager --enable crb &amp;&amp; dnf install epel-release -y &amp;&amp; dnf update -y\n</code></pre> <p><code>Cheque</code> os reposit\u00f3rios adicionados com o comando:</p> <pre><code>dnf repolist\n</code></pre> <p>O resultado deve ser algo como:</p> <p></p>"},{"location":"sambadc1/samba-ad-dc1/#setar-servidor-ntp-horario","title":"Setar servidor NTP (hor\u00e1rio):","text":"<p>Listando as op\u00e7\u00f5es de hora local.</p> <pre><code>timedatectl list-timezones\n</code></pre> <p>Para setar o <code>timezone</code> desejado, use o comando:\u00a0</p> <pre><code>timedatectl set-timezone America/Sao_Paulo \n</code></pre> <p>Verifique o <code>timezone</code> setado:</p> <pre><code>timedatectl\n</code></pre> <p>O resultado deve parecer como abaixo:</p> <pre><code>Local time: qua 2023-04-12 09:04:22 -03\n           Universal time: qua 2023-04-12 12:04:22 UTC\n                 RTC time: qua 2023-04-12 12:00:16\n                Time zone: America/Sao_Paulo (-03, -0300)\nSystem clock synchronized: yes\n              NTP service: active\n          RTC in local TZ: no \n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#instale-dependencias-necessarias","title":"Instale depend\u00eancias necess\u00e1rias","text":"<p>Instale as depend\u00eancias necess\u00e1rias para compilar e instalar o samba. Crie um arquivo do tipo <code>script execut\u00e1vel</code> e insira os comandos. No <code>terminal</code>, execute o editor de textos <code>nano</code> com o nome desejado do arquivo:</p> <pre><code>nano depende.sh\n</code></pre> <p><code>Copie</code> e <code>Cole</code> as linhas abaixo para o seu arquivo:</p> <pre><code>set -xueo pipefail\n\ndnf install -y yum-utils\ndnf update -y\n\nyum install -y \\\ngcc.x86_64 \\\nkrb5-workstation.x86_64 \\\ntar \\\nbind \\\nbind-utils \\\npython3-devel \\\nwget \\\nnano \\\nperl.x86_64 perl-Parse-Yapp.noarch \\\nlibacl.x86_64 \\\nnfs4-acl-tools.x86_64 \\\ngnutls-devel.x86_64 \\\nzlib.x86_64 \\\nkrb5-devel.x86_64 \\\nkrb5-server \\\nlibblkid.x86_64 \\\ndbus-devel.x86_64 \\\njansson-devel.x86_64 \\\nreadline.x86_64 \\\nbsdtar.x86_64 \\\ndocbook-dtds.noarch \\\npam-devel \\\ncups \\\npython3-markdown \\\npatchutils.x86_64 \\\ngpgme-devel \\\nflex \\\npython3-iso8601.noarch \\\npython3-cryptography.x86_64 \\\npython3.11-devel.x86_64 \\\nlmdb.x86_64 \\\nlibarchive-devel \\\nlibacl-devel \\\nopenldap-devel \\\npython3-dns \\\nperl-Convert-ASN1.noarch \\\nrpcgen.x86_64 \\\nperl-App-cpanminus \\\npopt-devel.x86_64 \\\nzlib-devel.x86_64 \\\nlmdb-devel.x86_64 \\\nbison-devel.x86_64 \\\nlibtasn1-tools \\\nbison \\\nperl-JSON \\\nbzip2-devel \\\nopenssl-devel \\\n\nyum autoremove -y\n\nyum clean all\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p> <p>Transforme o arquivo criado em um arquivo <code>execut\u00e1vel</code> com o comando:</p> <pre><code>chmod +x depende.sh\n</code></pre> <p>Vamos executar o arquivo para que o mesmo instale as depend\u00eancias necess\u00e1rias. Execute o arquivo com o comando:</p> <pre><code>./depende.sh \n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#download-do-samba-4195","title":"Download do Samba (4.19.5)","text":"<p>Fa\u00e7a o download do samba ou da vers\u00e3o desejada, utilizando o comando:</p> <pre><code>wget https://download.samba.org/pub/samba/stable/samba-4.19.5.tar.gz\n</code></pre> <p>Descompacte o arquivo utilizando o comando:</p> <pre><code>tar -zxvf samba-nome-arquivo\n</code></pre> <p>Mude para o diret\u00f3rio onde foi descompactado:</p> <pre><code>cd samba-nome-arquivo/\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#compilar-o-samba","title":"Compilar o Samba","text":"<p>Compile o samba e fa\u00e7a o arquivo de configura\u00e7\u00e3o (<code>smb.conf</code>)  ser gravado no diret\u00f3rio: /etc/samba/smb.conf . Execute o comando:</p> <pre><code>./configure --sysconfdir=/etc/samba/\n</code></pre> <p>Aguarde o processo finalizar.</p> <p>Se n\u00e3o houver nenhum erro, ao final, deve aparecer um resultado como a figura abaixo:</p> <p></p>"},{"location":"sambadc1/samba-ad-dc1/#comandos-make-e-make-install","title":"Comandos <code>make</code> e <code>make install</code>","text":"<p>Para finalizar a instala\u00e7\u00e3o do Samba execute os comandos <code>make</code> e <code>make install</code>:</p> <pre><code>make &amp;&amp; make install\n</code></pre> <p>Aten\u00e7\u00e3o: este processo pode demorar dependendo de seu hardware. Aguarde! </p> <p>Se n\u00e3o houver nenhum erro, ao final, deve aparecer um resultado parecido com a figura abaixo:</p> <p> </p>"},{"location":"sambadc1/samba-ad-dc1/#execute-o-samba-de-qualquer-diretorio","title":"Execute o <code>samba</code> de qualquer diret\u00f3rio","text":"<p>Mude para o diret\u00f3rio /root e edite o arquivo: <code>.bash_profile</code> com os comandos:</p> <pre><code>cd /root\nnano .bash_profile\n</code></pre> <p>Insira a linha:</p> <pre><code> .bash_profile\n\n# Get the aliases and functions\nif [ -f ~/.bashrc ]; then\n        . ~/.bashrc\nfi\n\n# User specific environment and startup programs\n\n# ESTA LINHA\nPATH=/usr/local/samba/bin/:/usr/local/samba/sbin/:$PATH\n\nexport PATH\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code> </p>"},{"location":"sambadc1/samba-ad-dc1/#servico-systemd-samba","title":"Servi\u00e7o <code>Systemd</code> Samba","text":"<p>Antes de criar o arquivo de servi\u00e7o systemd do samba execute os comandos:</p> <pre><code> systemctl mask smbd nmbd winbind\n systemctl disable smbd nmbd winbind\n</code></pre> <p>Crie o arquivo em: <code>/etc/systemd/system/samba-ad-dc.service</code> com o editor de textos <code>nano</code> </p> <pre><code>nano /etc/systemd/system/samba-ad-dc.service\n</code></pre> <p>Contendo as seguintes linhas (<code>copie</code> e <code>cole</code> para seu arquivo):</p> <pre><code>[Unit]\nDescription=Samba Active Directory Domain Controller\nAfter=network.target remote-fs.target nss-lookup.target\n\n[Service]\nType=forking\nExecStart=/usr/local/samba/sbin/samba -D\nPIDFile=/usr/local/samba/var/run/samba.pid\nExecReload=/bin/kill -HUP $MAINPID\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>Salve o arquivo</p> <p>Para salvar: <code>control+o</code> e para sair: <code>control+x</code></p> <p>Recarregue o <code>systemd</code> com o comando:</p> <pre><code>systemctl daemon-reload\n</code></pre> <p>Habilite o <code>samba-ad-dc</code> para iniciar no <code>boot</code> do sistema:</p> <pre><code>systemctl enable samba-ad-dc\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#verificar-dispositivo-de-rede","title":"Verificar dispositivo de rede","text":"<p>Verifique em qual dispositivo de rede est\u00e1 sua conex\u00e3o. No <code>terminal</code> execute o comando:</p> <pre><code>ip a\n</code></pre> <p>O resultado deve ser parecido como abaixo:</p> <pre><code>2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    link/ether de:1e:07:63:42:51 brd ff:ff:ff:ff:ff:ff\n    altname enp0s18\n    inet 10.1.1.120/24 brd 10.1.1.255 scope global noprefixroute ens18\n</code></pre> <p>OBS: o ens18 neste caso \u00e9 seu dispositivo de rede</p>"},{"location":"sambadc1/samba-ad-dc1/#desabilitar-selinux","title":"Desabilitar SELinux","text":"<p>Edite o arquivo <code>/etc/selinux/config</code>  com o editor nano:</p> <pre><code>nano /etc/selinux/config\n</code></pre> <p>Encontre a linha e mude para <code>disabled</code> como mostra abaixo:</p> <pre><code># disabled - No SELinux policy is loaded.\nSELINUX=disabled\n</code></pre> <p>Salve o arquivo:</p> <p>Para salvar: <code>control+o</code> e para sair <code>control+x</code></p>"},{"location":"sambadc1/samba-ad-dc1/#reboot-o-sistema","title":"Reboot o sistema","text":"<p>Fa\u00e7a um <code>reboot</code> do sistema com o comando:</p> <pre><code>reboot\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#provisionar-o-samba","title":"Provisionar o Samba","text":"<p>Vamos Provisionar o Samba. No terminal execute o comando:</p> <p><code>Obs: n\u00e3o esque\u00e7a de alterar para o seu dispositivo de rede</code></p> <pre><code>samba-tool domain provision --use-rfc2307 --interactive --option=\"interfaces= lo ens18\" --option=\"bind interfaces only=yes\"\n</code></pre> <p>Responda as <code>quest\u00f5es</code> referente ao seu cen\u00e1rio:</p> <pre><code>Realm: SEU.Dominio \nDomain [AD]: Dom\u00ednio  \nServer Role (dc, member, standalone) [dc]: dc \nDNS backend (SAMBA_INTERNAL, BIND9_FLATFILE, BIND9_DLZ, NONE) SAMBA_INTERNAL]: SAMBA_INTERNAL \nDNS forwarder IP address (write 'none' to disable forwarding) [SEU_IP_DNS]:IP DNS  \nAdministrator password: escolher uma senha  \nRetype password: repetir a mesma senha\n</code></pre> <p>OBS: Guarde a senha de provisionamento</p>"},{"location":"sambadc1/samba-ad-dc1/#configure-o-arquivo-krb5conf","title":"Configure o arquivo <code>krb5.conf</code>","text":"<p>Execute o comando abaixo:</p> <pre><code>cp /usr/local/samba/private/krb5.conf /etc/krb5.conf\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#restart-o-servico-do-samba-ad-dc-com-o-comando","title":"<code>Restart</code> o servi\u00e7o do <code>samba-ad-dc</code> com o comando:","text":"<pre><code>systemctl restart samba-ad-dc\n</code></pre> <p>Para <code>parar</code> servi\u00e7o fazer o comando:</p> <pre><code>systemctl stop samba-ad-dc\n</code></pre> <p>Se necessitar <code>desabilitar</code> o servi\u00e7o, utilizar o comando:</p> <pre><code>systemctl disable samba-ad-dc\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#verificar-versao-do-samba","title":"Verificar <code>vers\u00e3o</code> do samba","text":"<pre><code>smbclient --version\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#testar-o-samba","title":"<code>Testar</code> o samba","text":"<pre><code>smbclient -L localhost -U%\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#verificar-o-dns-ldap","title":"Verificar o DNS (<code>ldap</code>)","text":"<pre><code>host -t SRV _ldap._tcp.seu.dominio\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#verificar-kerberos","title":"Verificar <code>kerberos</code>","text":"<pre><code> host -t SRV _kerberos._udp.seu.dominio.\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#verificar-a-gravacao-a","title":"Verificar a <code>Grava\u00e7\u00e3o A</code>","text":"<pre><code>host -t A seu.dominio\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#verificar-a-autenticacao-do-kerberos","title":"Verificar a <code>autentica\u00e7\u00e3o</code> do Kerberos","text":"<p>A senha utilizada ser\u00e1 sua senha inserida no provisionamento do samba. Execute o comando abaixo: </p> <pre><code>kinit Administrator\nPassword for Administrator@SEU.DOMINIO:\nWarning: Your password will expire in 41 days on Tue 22 Sep 2020 03:41:22 PM IST\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#listar-o-cache-dos-tickets","title":"<code>Listar</code> o cache dos tickets","text":"<p>Liste o cache dos tickets com o comando:</p> <pre><code>klist\n</code></pre> <p>A resposta deve ser parecida com essa:</p> <pre><code>Valid starting       Expires              Service principal\n13/04/2023 13:54:57  13/04/2023 23:54:57  krbtgt/SEU.DOMINIO@SEU.DOMINIO\n    renew until 14/04/2023 13:54:50\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#configure-o-firewall","title":"Configure o Firewall","text":"<p>Adicione os <code>servi\u00e7os: dns, ldap, ldaps e kerberos</code> com o comando:</p> <pre><code>firewall-cmd --add-service={dns,ldap,ldaps,kerberos}\n</code></pre> <p>Abra as portas <code>TCP</code> utilizadas pelo samba:</p> <pre><code>firewall-cmd --permanent --zone=public --add-port={53/tcp,88/tcp,135/tcp,139/tcp,389/tcp,445/tcp,464/tcp,636/tcp,3268/tcp,3269/tcp,49152-65535/tcp};\n</code></pre> <p>Abra as portas <code>UDP</code> utilizadas pelo samba:</p> <pre><code>firewall-cmd --permanent --zone=public --add-port={53/udp,88/udp,123/udp,137/udp,138/udp,389/udp,464/udp};\n</code></pre> <p><code>Recarregue</code> o Firewall com o comando:</p> <pre><code>firewall-cmd --reload\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#replicacao-do-sysvol","title":"Replica\u00e7\u00e3o do SysVol","text":"<p>Replicar o SysVol (backup do AD-DC1) para um Segundo Controlador de Dom\u00ednio: DC2. Para fazer o segundo DC2 clique aqui .</p> <p>Gere uma chave <code>ssh</code> com o comando: <code>ssh-keygen</code> no <code>Primeiro Controlador de Dom\u00ednio</code> DC1 com o comando:</p> <pre><code>ssh-keygen -t rsa\n</code></pre> <p>Algumas perguntas ser\u00e3o feitas, como estas abaixo:</p> <p>Onde salvar o arquivo de chave, que neste caso: (/root/.ssh/id_rsa): tecle enter</p> <p>Entre com uma senha (ou apenas digite enter para ficar sem senha): tecle enter</p> <p>Entre com a senha novamente. Apenas: tecle enter</p> <p>A sa\u00edda ser\u00e1 algo como:</p> <pre><code>Your identification has been saved in /root/.ssh/id_rsa.\nYour public key has been saved in /root/.ssh/id_rsa.pub.\n</code></pre> <p>Assim que a chave for criada, precisamos copia-la para o <code>Segundo Controlador de Dom\u00ednio</code> DC2. Execute o comando:</p> <pre><code>ssh-copy-id root@IP-Seu-DC2\n</code></pre> <p>Insira a senha do <code>root</code> de seu DC2. Ap\u00f3s a resposta do comando a chave criada ser\u00e1 copiada para o seu DC2 e estar\u00e1 apto a acessar o DC2 de forma autom\u00e1tica.</p> <p>Ap\u00f3s o comando, uma tela parecida com a sa\u00edda abaixo deve aparecer.</p> <p>Analise os comandos na figura abaixo:</p> <p></p>"},{"location":"sambadc1/samba-ad-dc1/#volte-para-seu-dc1","title":"Volte para seu DC1","text":""},{"location":"sambadc1/samba-ad-dc1/#backup-arquivo-idmapldb","title":"Backup arquivo <code>idmap.ldb</code>","text":"<p>No seu DC1:</p> <p>Para fazer a <code>replica\u00e7\u00e3o</code> do <code>sysvol</code> do DC1 para o DC2, o <code>DC2</code> deve ter o mesmo mapa ID para os usu\u00e1rios e grupos. Execute o comando para fazer um backup do arquivo idmap.ldb:</p> <pre><code>tdbbackup -s.bak /usr/local/samba/private/idmap.ldb idmap.bak\n</code></pre> <p>Com o arquivo de backup gerado: <code>idmap.ldb.bak</code> vamos utilizar o comando <code>pwd</code> que lista o caminho de diret\u00f3rio que estamos e com o comando <code>ls idmap.ldb.bak</code> listamos o arquivo desejado.</p> <p>Analise a figura:</p> <p></p> <p>Podemos copiar o arquivo gerado para o caminho de seu DC2 executando o comando:</p> <pre><code>scp /usr/local/samba/private/idmap.ldb.bak root@IP-SEU-DC2:/usr/local/samba/private/\n</code></pre> <p>Veja a figura:</p> <p></p>"},{"location":"sambadc1/samba-ad-dc1/#conecte-se-ao-seu-dc2","title":"Conecte-se ao seu DC2","text":"<p>Conecte-se ao DC2 para renomear o arquivo de backup enviado atrav\u00e9s do DC1 (idmap.ldb.bak). Para renomear o arquivo, utilize o comando:</p> <pre><code>mv /usr/local/samba/private/idmap.ldb.bak idmap.ldb\n</code></pre> <p>Analise as figuras:</p> <p></p> <p>Listando o arquivo renomeado no DC2 (idmap.ldb)</p> <p></p>"},{"location":"sambadc1/samba-ad-dc1/#reconecte-se-ao-seu-dc1","title":"Reconecte-se ao seu DC1","text":""},{"location":"sambadc1/samba-ad-dc1/#comando-ntacl-samba-tool","title":"Comando NTACL (samba-tool)","text":"<p>Execute o comando em seu DC1 (Controlador de Dom\u00ednio Principal):</p> <pre><code>samba-tool ntacl sysvolreset\n</code></pre>"},{"location":"sambadc1/samba-ad-dc1/#sysvol-backup-dc1-para-membro-dc2","title":"Sysvol Backup (DC1 para membro DC2)","text":"<p>Vamos executar um backup do <code>DC1</code> para o <code>DC2</code>. Para efeito de <code>teste</code>, execute o comando utilizando a op\u00e7\u00e3o <code>--dry-run</code> para um teste <code>sem altera\u00e7\u00f5es</code>:</p> <pre><code>rsync --dry-run -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol root@IP-DC2:/usr/local/samba/var/locks/sysvol/\n</code></pre> <p>O comando rsync far\u00e1 uma copia do sysvol de seu <code>DC1</code> (parte1) para o sysvol de seu <code>DC2</code> (parte2): Verifique:</p> <p><code>Parte 1:</code></p> <p>rsync --dry-run -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol/</p> <p><code>Parte 2:</code></p> <p>root@IP-DC2:/usr/local/samba/var/locks/sysvol/</p> <p>O resultado deve ser algo parecido como abaixo:</p> <pre><code>building file list ... \n12 files to consider\n./\nseu.dominio/\nseu.dominio/Policies/\nseu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/\nseu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/GPT.INI\nseu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/\nseu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/USER/\nseu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/\nseu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/GPT.INI\nseu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/MACHINE/\nseu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/USER/\nseu.dominio/scripts/\n\nNumber of files: 12 (reg: 2, dir: 10)\nNumber of created files: 9 (reg: 2, dir: 7)\nNumber of deleted files: 0\nNumber of regular files transferred: 2\nTotal file size: 40 bytes\nTotal transferred file size: 40 bytes\nLiteral data: 0 bytes\nMatched data: 0 bytes\nFile list size: 0\nFile list generation time: 0.038 seconds\nFile list transfer time: 0.000 seconds\nTotal bytes sent: 2,011\nTotal bytes received: 51\n\nsent 2,011 bytes  received 51 bytes  1,374.67 bytes/sec\ntotal size is 40  speedup is 0.02 **(DRY RUN)**\n</code></pre> <p>Com o resultado positivo (sem erros), utilize o comando sem a op\u00e7\u00e3o --dry-run . Desta forma o comando <code>realmente</code> ser\u00e1 executado.</p> <pre><code>rsync -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol dc2@IP-DC2:/usr/local/samba/var/locks/sysvol/\n</code></pre> <p>O resultado deve ser parecido como mostra abaixo:</p> <pre><code>building file list ... \n12 files to consider\n./\nseu.dominio/\nseu.dominio/Policies/\nseu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/\nseu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/GPT.INI\n             20 100%    0.00kB/s    0:00:00 (xfr#1, to-chk=7/12)\nseu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/\nseu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/USER/\nseu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/\nseu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/GPT.INI\n             20 100%   19.53kB/s    0:00:00 (xfr#2, to-chk=3/12)\nseu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/MACHINE/\nseu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/USER/\nseu.dominioscripts/\ndeleting sysvol/seu.dominio/scripts/\ndeleting sysvol/seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/USER/\ndeleting sysvol/seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/MACHINE/\ndeleting sysvol/seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/GPT.INI\ndeleting sysvol/seu.dominio/Policies/{6AC1786C-016F-11D2-945F-00C04FB984F9}/\ndeleting sysvol/seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/USER/\ndeleting sysvol/seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/\ndeleting sysvol/seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/GPT.INI\ndeleting sysvol/seu.dominio/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/\ndeleting sysvol/seu.dominio/Policies/\ndeleting sysvol/seu.dominio/\ndeleting sysvol/\n\nNumber of files: 12 (reg: 2, dir: 10)\nNumber of created files: 9 (reg: 2, dir: 7)\nNumber of deleted files: 12 (reg: 2, dir: 10)\nNumber of regular files transferred: 2\nTotal file size: 40 bytes\nTotal transferred file size: 40 bytes\nLiteral data: 40 bytes\nMatched data: 0 bytes\nFile list size: 0\nFile list generation time: 0.012 seconds\nFile list transfer time: 0.000 seconds\nTotal bytes sent: 4,091\nTotal bytes received: 106\n\nsent 4,091 bytes  received 106 bytes  2,798.00 bytes/sec\ntotal size is 40  speedup is 0.01\n</code></pre> <p>Para automatizar o processo, insira o comando no crontab. Para aprender mais sobre o crontab clique aqui</p>"},{"location":"sambadc1/samba-ad-dc1/#script-crontab","title":"Script crontab","text":"<p>Adicione um script no crontab para o backup ser autom\u00e1tico com o comando:</p> <pre><code>crontab -e\n</code></pre> <p>Se for a primeira vez que executou este comando, pode aparecer um breve menu para selecionar o editor desejado como mostra abaixo. Selecione a <code>op\u00e7\u00e3o 1</code> para o editor de textos <code>nano</code>:</p> <pre><code>Select an editor.  To change later, run 'select-editor'.\n  1. /bin/nano        &lt;---- easiest\n  2. /usr/bin/vim.tiny\n  3. /bin/ed\n</code></pre> <p>V\u00e1 at\u00e9 a \u00faltima linha e insira a linha de comando como abaixo:</p> <pre><code>0 12 * * 1-5 root rsync -XAavz --delete-after --progress --stats /usr/local/samba/var/locks/sysvol/ root@IP-DC2:/usr/local/samba/var/locks/sysvol/\n</code></pre> <p>Para salvar o arquivo, utilize o comando:</p> <p>Para salvar <code>control+o</code> e para sair <code>control+x</code></p>"},{"location":"thanks/thanks/","title":"Agradecimentos","text":"<p>Gostaria de agradecer todas as pessoas que ajudaram a realizar esta documenta\u00e7\u00e3o:</p> <ul> <li> <p>Amigos do Trabalho</p> </li> <li> <p>Canal no Telegram SAMBA4BR</p> </li> </ul> <p>O que utilizei para fazer o laborat\u00f3rio?</p> <ul> <li> <p>Linux Mint 21.3 </p> </li> <li> <p>Gerenciador de M\u00e1quinas Virtuais KVM</p> </li> <li> <p>3 Rocky Linux modo servidor vers\u00e3o: 9.4</p> </li> <li> <p>Windows 11 Pro </p> </li> <li> <p>MarkText Editor de documentos markdown</p> </li> </ul>"},{"location":"win11/Windows11/","title":"Windows 11 RSAT","text":""},{"location":"win11/Windows11/#windows-11-e-instalacao-do-rsat","title":"Windows 11 e Instala\u00e7\u00e3o do RSAT","text":"<p>Vamos integrar o Windows 11 ao Samba AD-DC (DC1) e instalar a <code>Ferramenta de Administra\u00e7\u00e3o Remota de Servi\u00e7o AD</code>. Somente as vers\u00f5es <code>Pro</code> e posteriores ter\u00e3o a op\u00e7\u00e3o de se integrar ao AD-DC.</p> <p>OBS: Seu <code>DC1</code> e <code>Servidor de Arquivos</code> devem estar operacionais e funcionando corretamente.</p> <p>Antes de qualquer altera\u00e7\u00e3o no sistema, \u00e9 importante que esteja configurado o DNS no Windows, sendo o IP de seu Controlador de dom\u00ednio (DC1). Sem esta configura\u00e7\u00e3o o windows n\u00e3o ser\u00e1 capaz de encontrar seu DC1 e claro, n\u00e3o ser\u00e1 poss\u00edvel <code>juntar-se</code> (join) ao mesmo. Configure tamb\u00e9m um IP est\u00e1tico para o sistema.</p> <p>Na tela do Sistema Windows, na barra de tarefas clique no <code>\u00edcone</code> de <code>rede</code> perto do rel\u00f3gio e logo ap\u00f3s, na <code>engrenagem</code> como mostra a figura abaixo: </p> <p></p> <p>Na pr\u00f3xima tela clique em Rede e Internet e selecione Ethernet. Analise a Figura abaixo:</p> <p></p> <p>Na pr\u00f3xima tela clique em Editar como mostra a figura:</p> <p></p> <p>Continuando. Nesta pr\u00f3xima tela configure as op\u00e7\u00f5es referente ao seu cen\u00e1rio: Endere\u00e7o IP, Gateway e o DNS Preferencial, no caso, ser obrigat\u00f3riamente o IP de seu DC1. Ap\u00f3s a configura\u00e7\u00e3o clique em Salvar. Analise a figura abaixo:</p> <p></p> <p>Vamos adicionar este Windows no AD. Selecione a op\u00e7\u00e3o Conta Clique em Conectar e selecione: Adicionar este dispositivo a um dom\u00ednio local do Active Directory</p> <p>Analise a figura abaixo:</p> <p></p> <p>Insira o nome de seu dom\u00ednio que deseja Ingressar e Clique em Avan\u00e7ar.</p> <p>Veja a figura abaixo:</p> <p></p> <p>O sistema ir\u00e1 solicitar uma conta. Adicione a conta  <code>Administrator</code> e a senha quando o samba foi provisionado.</p> <p>Veja a figura abaixo:</p> <p></p> <p>Confime o tipo da conta como sendo <code>Administrador</code> e clique em Avan\u00e7ar</p> <p>Veja a figura abaixo:</p> <p></p> <p>O sistema vai solicitar que Reinicie seu sistema </p> <p>Veja a figura abaixo:</p> <p></p> <p>Quando reiniciar, insira seu usu\u00e1rio Administrator e a senha.</p> <p>Veja a figura abaixo:</p> <p></p> <p>Vamos instalar a ferramenta RSAT. No menu do sistema, digite Configura\u00e7\u00f5es - Sistema - Recursos Opcionais. Clique em Exibir Recursos:</p> <p>Veja a figura abaixo:</p> <p></p> <p>No caminho de procura, escreva Ferramentas e selecione para instalar: Ferramenta de Adminitra\u00e7\u00e3o Remoto. Active Directory Domain Services e Lightweight Directory Services Tools. Clique em Avan\u00e7ar e aguarde finalizar a instala\u00e7\u00e3o. </p> <p>Veja a figura abaixo:</p> <p></p> <p>Buscando no Sistema por Ferramentas Windows, estar\u00e1 apto a iniciar a configura\u00e7\u00e3o e adminitra\u00e7\u00e3o de seu AD.</p> <p>Veja a figura abaixo:</p> <p></p>"}]}